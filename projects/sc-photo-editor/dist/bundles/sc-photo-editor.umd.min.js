!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("fabric"),require("rxjs"),require("@angular/core")):"function"==typeof define&&define.amd?define("sc-photo-editor",["exports","fabric","rxjs","@angular/core"],e):e(t["sc-photo-editor"]={},t.fabric,t.rxjs,t.ng.core)}(this,function(t,i,e,r){"use strict";var o=(a.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],a.ctorParameters=function(){return[]},a.ngInjectableDef=r.defineInjectable({factory:function(){return new a},token:a,providedIn:"root"}),a);function a(){}var n=(s.createCanvasElement=function(t){var e;return(e=document.createElement("canvas")).id=t||Date.now(),e},s.decorators=[{type:r.Injectable}],s);function s(){}var c=(h.prototype.ngAfterViewInit=function(){var i=this;this.initWorkspace(),e.combineLatest(this.mode$,this.source$).subscribe(function(t){var e=function c(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,o,a=i.call(t),n=[];try{for(;(void 0===e||0<e--)&&!(r=a.next()).done;)n.push(r.value)}catch(s){o={error:s}}finally{try{r&&!r.done&&(i=a["return"])&&i.call(a)}finally{if(o)throw o.error}}return n}(t,1)[0];return i.switchToMode(e)})},h.prototype.ngOnChanges=function(t){t.source&&t.source.currentValue&&this.setSource(this.source),t.mode&&t.mode.currentValue&&this.setMode(this.mode)},h.prototype.initWorkspace=function(){this.canvas=new i.fabric.Canvas("sc-canvas"),this.canvas.setWidth(this.editorWidth),this.canvas.setHeight(this.editorWidth/this.aspectRatio)},h.prototype.setSource=function(t){var e=this;i.fabric.Image.fromURL(t,function(t){e.canvasSource=t,e.originalSource=t.getElement(),e.prepareCanvasImage(t),e._source$.next(t)})},h.prototype.setMode=function(t){this._mode$.next(t)},h.prototype.switchToMode=function(t){switch(t){case"crop":this.initCropper();break;case"blur":this.initBlur()}},h.prototype.prepareCanvasImage=function(t){t.set({originX:"left",originY:"top",width:this.originalSource.width,height:this.originalSource.height,selectable:!1}),this.disableImageCorners(t),this.currentScaleLevel=this.minScaleLevel=this.getMinScaleLevel(t),t.scale(this.currentScaleLevel),this.canvas.add(t),this.canvas.renderAll()},h.prototype.getOrientation=function(t,e){return e<t?"landscape":t<e?"portrait":t===e?"square":void 0},h.prototype.disableImageCorners=function(t){t.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!1,mtr:!1,tl:!1,tr:!1})},h.prototype.getMinScaleLevel=function(t){var e,i;return e=this.getOrientation(this.canvas.getWidth(),this.canvas.getHeight()),i=this.getOrientation(t.width,t.height),"portrait"===e&&"landscape"===i||"landscape"===e&&"portrait"===i||"portrait"===e&&"square"===i?this.canvas.getHeight()/t.height:this.canvas.getWidth()/t.width},h.prototype.sourceMoveListener=function(t){var e=t.target;0<=e.left?e.left=0:(Math.abs(e.left)+e.canvas.width)/e.scaleX>this.originalSource.width&&(e.left=-(this.originalSource.width*e.scaleX-e.canvas.width)),0<=e.top?e.top=0:(Math.abs(e.top)+e.canvas.height)/e.scaleY>this.originalSource.height&&(e.top=-(this.originalSource.height*e.scaleY-e.canvas.height))},h.prototype.sourceMoveEndListener=function(t){var e=this.getComputedStyle();console.log(e),this.updatePreviewCanvas(t.target,e),this.changed.next(this.previewCanvas.toDataURL("png"))},h.prototype.preparePreviewCanvas=function(){this.previewCanvas||(this.previewCanvas=n.createCanvasElement(),console.log(this.computedStyle.width),this.previewCanvas.width=this.exportWidth?this.exportWidth:this.computedStyle.width,this.previewCanvas.height=this.exportWidth?this.exportWidth/this.aspectRatio:this.computedStyle.height,this.previewCanvas.getContext("2d").drawImage(this.originalSource,0,0))},h.prototype.resetPreviewCanvas=function(){this.previewCanvas=null,this.preparePreviewCanvas()},h.prototype.updatePreviewCanvas=function(t,e){this.previewCanvas.getContext("2d").drawImage(this.originalSource,e.left,e.top,e.width,e.height,0,0,this.previewCanvas.width,this.previewCanvas.height)},h.prototype.getComputedStyle=function(){return{left:Math.round(Math.abs(this.canvasSource.left)/this.currentScaleLevel),top:Math.round(Math.abs(this.canvasSource.top)/this.currentScaleLevel),width:Math.round(this.canvas.getWidth()/this.currentScaleLevel),height:Math.round(this.canvas.getHeight()/this.currentScaleLevel)}},h.prototype.setScale=function(t){var e=1<t?1:t;this.currentScaleLevel=e,this.canvasSource.scale(e),this.computedStyle=this.getComputedStyle(),this.resetPreviewCanvas(),this.canvas.renderAll()},h.prototype.initCropper=function(){var e=this;this.canvasSource.selectable=!0,this.canvasSource.on("moving",function(t){return e.sourceMoveListener(t)}),this.canvasSource.on("moved",function(t){return e.sourceMoveEndListener(t)}),this.computedStyle=this.getComputedStyle(),this.preparePreviewCanvas()},h.prototype.initBlur=function(){this.canvasSource.selectable=!1},h.decorators=[{type:r.Component,args:[{selector:"sc-photo-editor",template:'<div class="sc-canvas-wrapper">\r\n  <canvas id="sc-canvas"></canvas>\r\n</div>\r\n',providers:[n]}]}],h.ctorParameters=function(){return[{type:n}]},h.propDecorators={editorWidth:[{type:r.Input}],exportWidth:[{type:r.Input}],aspectRatio:[{type:r.Input}],source:[{type:r.Input}],mode:[{type:r.Input}],changed:[{type:r.Output}]},h);function h(t){this.helpers=t,this._mode$=new e.ReplaySubject(1),this._source$=new e.ReplaySubject(1),this.mode$=this._mode$.asObservable(),this.source$=this._source$.asObservable(),this.changed=new r.EventEmitter,this.minScaleLevel=0,this.maxScaleLevel=1}var p=(u.decorators=[{type:r.NgModule,args:[{declarations:[c],imports:[],exports:[c]}]}],u);function u(){}t.ScPhotoEditorService=o,t.ScPhotoEditorComponent=c,t.ScPhotoEditorModule=p,t.Éµa=n,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=sc-photo-editor.umd.min.js.map